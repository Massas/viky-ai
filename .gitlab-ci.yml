stages:
  - build
  - test
  - docker_tag
  - deploy
  - admin

variables:
  GIT_SUBMODULE_STRATEGY: none
  DOCKER_IMAGE_APP: $CI_REGISTRY_IMAGE/app
  DOCKER_IMAGE_NLP: $CI_REGISTRY_IMAGE/nlp
  DOCKER_IMAGE_TOOLS_BACKUP: $CI_REGISTRY_IMAGE/tools_backup
  DOCKER_IMAGE_DOC: docker-registry.pertimm.net/viky.ai/doc
  DOCKERHUB_IMAGE_NLP: "vikyai/nlp"
  DOCKERHUB_IMAGE_APP: "vikyai/app"
  DOCKERHUB_IMAGE_TOOLS_BACKUP: "vikyai/tools_backup"
  DOCKERHUB_IMAGE_DOC: vikyai/doc

image: vikyai/tools-gitlab-auto-deploy-image:latest
before_script:
  - if [ "${TRACE:-false}" == "true" ] ; then  set -x ; fi
  # load auto-deploy if exits (not in test)
  - if [ -f /auto-deploy.sh ]; then . /auto-deploy.sh ; fi

.kubernetes_runner:
  environment:
    name: dev-${CI_COMMIT_REF_NAME}
  tags:
    - kubernetes
  variables:
    CI_SERVICE_HOST: "127.0.0.1"

# Build docker image
build_backup:
  extends: .kubernetes_runner
  stage: build
  script:
    - docker_build ${DOCKER_IMAGE_TOOLS_BACKUP} deployment/docker_tools/backup

build_webapp:
  extends: .kubernetes_runner
  stage: build
  script:
    - docker_build ${DOCKER_IMAGE_APP}      webapp "--target image_ruby_run"
    - docker_build ${DOCKER_IMAGE_APP}_test webapp "--target image_ruby_test"

build_nlp:
  extends: .kubernetes_runner
  stage: build
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
  script:
    - docker_build ${DOCKER_IMAGE_NLP}      nlp "--target run_image"
    - docker_build ${DOCKER_IMAGE_NLP}_test nlp "--target test_image"

# Test
test_webapp:
  extends: .kubernetes_runner
  stage: test
  image: ${DOCKER_IMAGE_APP}_test:${CI_COMMIT_REF_SLUG}
  needs:
    - "build_webapp"
  variables:
    POSTGRES_USER: superman
    POSTGRES_PASSWORD: sup_3rman
    POSTGRES_DB: vikyapp_test
    ES_JAVA_OPTS: "-Xms128m -Xmx392m"
  services:
    - postgres:11.5-alpine
    - redis:5.0-alpine
    - name: selenium/standalone-chrome:3.141.59
      alias: selenium-chrome
    - name: docker.elastic.co/elasticsearch/elasticsearch:7.3.2
      # Important other wise, port 9200 will never be exposed
      command:
        [
          "bin/elasticsearch",
          "-Ediscovery.type=single-node",
          "-Enetwork.host=0.0.0.0",
        ]
      alias: elasticsearch
  script:
    - export VIKYAPP_DB_USERNAME="${POSTGRES_USER}"
    - export VIKYAPP_DB_PASSWORD="${POSTGRES_PASSWORD}"
    - export VIKYAPP_DB_HOST="${CI_SERVICE_HOST:-postgres}"
    - export VIKYAPP_ACTIONCABLE_REDIS_URL="redis://${CI_SERVICE_HOST:-redis}:6379/1"
    - export VIKYAPP_ACTIVEJOB_REDIS_URL="redis://${CI_SERVICE_HOST:-redis}:6379/2"
    - export VIKYAPP_STATISTICS_URL="http://${CI_SERVICE_HOST:-elasticsearch}:9200"
    - export SELENIUM_REMOTE_URL="http://${CI_SERVICE_HOST:-selenium-chrome}:4444/wd/hub/"
    - export VIKYAPP_STATISTICS_NO_REPLICA="true"
    - cd /webapp
    - if [ "${SKIP_TEST:-false}" != "true" ]; then ./bin/docker_run_test.sh ; fi
  artifacts:
    # expire_in: 1 week
    reports:
      junit: "reports/TEST-*.xml"

test_nlp:
  extends: .kubernetes_runner
  stage: test
  needs:
    - "build_nlp"
  image: ${DOCKER_IMAGE_NLP}_test:${CI_COMMIT_REF_SLUG}
  services:
    - redis:5.0-alpine
  variables:
    GIT_STRATEGY: none
  script:
    - export VIKYAPP_REDIS_PACKAGE_NOTIFIER="redis://${CI_SERVICE_HOST:-redis}:6379/3"
    - if [ "${SKIP_TEST:-false}" != "true" ]; then /docker_run_test.sh ; fi
  artifacts:
    # expire_in: 1 week
    reports:
      junit:
        - "reports/TEST-*.xml"

# Tag docker image to lasted
tag_latest:
  extends: .kubernetes_runner
  stage: docker_tag
  variables:
    GIT_STRATEGY: none
  only:
    - master
  script:
    - docker_tag_latest ${DOCKER_IMAGE_APP}
    - docker_tag_latest ${DOCKER_IMAGE_NLP}
    - docker_tag_latest ${DOCKER_IMAGE_TOOLS_BACKUP}

# Push Docker image to Dockerhub only when on Master and it's a Tag
push_dockerhub:
  extends: .kubernetes_runner
  stage: docker_tag
  only:
    - tags
    - master
  environment:
    name: viky-ai-production
  script:
    - export VIKY_GITLAB_TAG="${CI_COMMIT_REF_SLUG:-latest}"
    - export VIKY_DOCKERHUB_TAG="latest"
    - docker_push_gitlab_to_dockerhub "${DOCKER_IMAGE_NLP}:${VIKY_GITLAB_TAG}"          "${DOCKERHUB_IMAGE_NLP}:${VIKY_DOCKERHUB_TAG}"
    - docker_push_gitlab_to_dockerhub "${DOCKER_IMAGE_APP}:${VIKY_GITLAB_TAG}"          "${DOCKERHUB_IMAGE_APP}:${VIKY_DOCKERHUB_TAG}"
    - docker_push_gitlab_to_dockerhub "${DOCKER_IMAGE_TOOLS_BACKUP}:${VIKY_GITLAB_TAG}" "${DOCKERHUB_IMAGE_TOOLS_BACKUP}:${VIKY_DOCKERHUB_TAG}"

# Deploy generic job

.deploy_dev:
  needs:
    - build_backup
    - test_webapp
    - test_nlp
  except:
    - master
    - tags
  environment:
    name: dev-${CI_COMMIT_REF_NAME}
    url: https://viky-${CI_ENVIRONMENT_SLUG}-kube.viky.ai
  variables:
    S3_ACCESS_KEY: ${S3_ACCESS_KEY}
    S3_SECRET_KEY: ${S3_SECRET_KEY}
    VIKY_USE_DOCKERHUB_IMAGE: "false"
    HELM_RELEASE_NAME: "viky-dev"
    HELM_VALUES: "viky/custom-values/dev.yaml,custom-values.yml"

.deploy_production:
  needs:
    - "push_dockerhub"
  only:
    - master
  except:
    - tags
  environment:
    name: viky-ai-production
    url: https://www.viky.ai
  variables:
    S3_ACCESS_KEY: ${S3_ACCESS_KEY}
    S3_SECRET_KEY: ${S3_SECRET_KEY}
    VIKY_DOCKER_TAG: "latest"
    VIKY_USE_DOCKERHUB_IMAGE: "true"
    VIKYAPP_AUTO_BACKUP: "true"
    HELM_RELEASE_NAME: "viky-prod"
    HELM_VALUES: "viky/custom-values/production.yaml,custom-values.yml"
    KUBE_NAMESPACE: viky-ai-production

.deploy:
  extends: .kubernetes_runner
  stage: deploy
  variables:
    VIKY_IMAGE_TAG: ${CI_COMMIT_REF_SLUG}
    HELM_TIMEOUT: "600"
    HELM_EXTRA_OPTIONS: "--wait"
  script:
    - kube_setup
    # current deployment status
    - helm history "${RELEASE_NAME}" || true
    - helm status  "${RELEASE_NAME}" || true
    # backup current env
    - if [ "${BACKUP_BEFORE_DEPLOY:-false}" == "true"Â ]; then kubectl exec $(kube_get_pods \"app=viky-webapp-backup\") bash /backup/backup.sh || true ; fi
    # Go to Kubernetes directory
    - cd deployment/kubernetes/
    - bin/generate-ci-override-values.sh
    - cat custom-values.yml
    # Deploy Viky Platform
    - HELM_OPTIONS="--install ${HELM_EXTRA_OPTIONS} --timeout ${HELM_TIMEOUT}  --values ${HELM_VALUES}"
    - echo "helm upgrade ${HELM_OPTIONS} "${RELEASE_NAME}" ./viky/"
    - helm upgrade ${HELM_OPTIONS} "${RELEASE_NAME}" ./viky/
    - notify_deployment

# Deploy any branches on dev

deploy_dev:
  environment:
    name: dev-${CI_COMMIT_REF_NAME}
    on_stop: delete_env
  extends:
    - .deploy
    - .deploy_dev

deploy_dev_forced:
  extends: deploy_dev
  environment:
    name: dev-${CI_COMMIT_REF_NAME}
    on_stop: delete_env
  when: manual
  variables:
    HELM_EXTRA_OPTIONS: "--force"

# Deploy master on preprod
deploy_production:
  extends:
    - .deploy
    - .deploy_production
  variables:
    BACKUP_BEFORE_DEPLOY: "true"

deploy_production_forced:
  extends: deploy_production
  when: manual
  variables:
    HELM_EXTRA_OPTIONS: "--force"

# remove environment only for dev
.delete_env:
  environment:
    name: dev-${CI_COMMIT_REF_NAME}
    action: stop
  stage: admin
  needs:
    # dummy needs to allow it directly
    - "build_backup"
  variables:
    GIT_STRATEGY: none
  script:
    - kube_setup
    - helm history "${RELEASE_NAME}" || true
    - helm status  "${RELEASE_NAME}" || true
    - kubectl delete secret --ignore-not-found viky-infra-es-keystore-secret
    - kube_cleanup
  when: manual
  allow_failure: true

delete_env:
  extends:
    - .kubernetes_runner
    - .deploy_dev
    - .delete_env

# invite admin user
.invite_admin:
  stage: admin
  variables:
    GIT_STRATEGY: none
  script:
    - kube_setup
    - PODNAME=$(kube_get_pods "app=viky-webapp")
    - kubectl exec ${PODNAME} ./bin/rails users:invite_admin[${GITLAB_USER_EMAIL}]
  when: manual
  allow_failure: true

invite_admin:
  extends:
    - .kubernetes_runner
    - .deploy_dev
    - .invite_admin

# backup
.backup:
  stage: admin
  variables:
    GIT_STRATEGY: none
  script:
    - kube_setup
    - PODNAME=$(kube_get_pods "app=viky-webapp-backup")
    - kubectl exec ${PODNAME}  bash /backup/backup.sh
  when: manual
  allow_failure: true

backup_dev:
  extends:
    - .kubernetes_runner
    - .deploy_dev
    - .backup

backup_production:
  extends:
    - .kubernetes_runner
    - .deploy_production
    - .backup

# backup restore only for dev
.backup_restore:
  stage: admin
  variables:
    GIT_STRATEGY: none
  script:
    - kube_setup
    - PODNAME=$(kube_get_pods "app=viky-webapp-backup")
    # backup current env
    - kubectl exec ${PODNAME}  bash /backup/backup.sh || true
    # restore base on viky-ai-production
    - kubectl exec ${PODNAME}  bash /backup/restore.sh "viky-ai-production"
    # delete pods to restart viky apps deployment
    - kubectl delete pods -l 'app in (viky-webapp-worker, viky-webapp, viky-nlp)'
  when: manual
  allow_failure: true

backup_restore:
  extends:
    - .kubernetes_runner
    - .deploy_dev
    - .backup_restore

# update homepage and doc to latest image
.update_doc:
  stage: admin
  variables:
    GIT_STRATEGY: none
  needs:
    # dummy needs to allow it directly
    - "build_backup"
  script:
    # update image fo the doc
    - export IMAGE_DOC="${DOCKER_IMAGE_DOC_OVERRIDE:-$DOCKERHUB_IMAGE_DOC}"
    - export IMAGE_DOC_TAG="${DOCKER_IMAGE_DOC_TAG_OVERRIDE:-latest}"
    - kube_setup
    - DOC_DIGEST_TAG=$(docker_digest_tag "${IMAGE_DOC}:${IMAGE_DOC_TAG}")
    - echo "Updating doc to ${IMAGE_DOC}:${DOC_DIGEST_TAG}"
    - kubectl set image deployments/viky-doc-deployment *="${IMAGE_DOC}:${DOC_DIGEST_TAG}"
  when: manual
  allow_failure: true

update_doc_dev:
  extends:
    - .kubernetes_runner
    - .deploy_dev
    - .update_doc

update_doc_production:
  extends:
    - .kubernetes_runner
    - .deploy_production
    - .update_doc

# Get deployment status
.deploy_status:
  stage: admin
  variables:
    GIT_STRATEGY: none
  needs:
    # dummy needs to allow it directly
    - "build_backup"
  script:
    - kube_setup
    - helm history "${RELEASE_NAME}" || true
    - helm status  "${RELEASE_NAME}"
  when: manual
  allow_failure: true

deploy_status_dev:
  extends:
    - .kubernetes_runner
    - .deploy_dev
    - .deploy_status

deploy_status_production:
  extends:
    - .kubernetes_runner
    - .deploy_production
    - .deploy_status
