<%= form_with model: [current_user, agent], data: { type: 'json' }, class: 'js-agent-form' do |f| %>


  <% if ["edit", "update"].include? action_name %>
    <div class="field field--api-token">
      <div class="control control--merged">
        <span class="addon">API token</span>
        <%= f.text_field :api_token, id: :agent_api_token, readonly: true %>
        <a href="<%= generate_token_user_agent_path(current_user, agent) %>" class="btn"
           data-action="generate-token" title="<%= t('views.agents.form.api_token.generate_btn') %>">
          <span class="icon icon--x-small"><%= icon_loading %></span>
        </a>
      </div>
      <%= display_errors(agent, :api_token) %>
    </div>
  <% end %>

  <div class="field">
    <div class="control">
      <%= f.label :name %>
      &nbsp;<span class="badge badge--small badge--outline"><%= t('required') %></span>
      <br />
      <%= f.text_field :name, id: :agent_name %>
      <%= display_errors(agent, :name) %>
    </div>
  </div>

  <div class="field">
    <%= f.label :agentname %>
    &nbsp;<span class="badge badge--small badge--outline"><%= t('required') %></span>
    <div class="control control--merged">
      <span class="addon">
        <% if ["edit", "update"].include? action_name %>
          <%= agent.owner.username %>/
        <% else %>
          <%= current_user.username %>/
        <% end %>
      </span>
      <%= f.text_field :agentname, id: :agent_agentname %>
    </div>
    <%= display_errors(agent, :agentname) %>
  </div>

  <div class="field">
    <div class="control">
      <%= f.label :visibility %>
      <%= f.hidden_field :visibility, value: 'is_private' %>
      <div class="dropdown">
        <div class="dropdown__trigger">
          <button class="btn">
            <span class="btn__label"><% if agent.is_private? %> <%= t('views.agents.form.visibility.is_private') %> <% else %> <%= t('views.agents.form.visibility.is_public') %> <% end %></span>
            <span class="icon icon--x-small">
              <%= icon_arrow_down %>
            </span>
          </button>
        </div>
        <div class="dropdown__content dropdown__content--on-right dropdown__content--hidden">
          <ul>
            <li>
              <a href="#" <% if agent.is_private? %> class="current" <% end %>
                 data-behavior="populate-input, replace-trigger-label"
                 data-replace-with="<%= t('views.agents.form.visibility.is_private') %>"
                 data-replace-selector=".btn__label"
                 data-input-selector="input[name='agent[visibility]']"
                 data-input-value="is_private">
                <%= t('views.agents.form.visibility.is_private') %>
              </a>
            </li>
            <li>
              <a href="#" <% if agent.is_public? %> class="current" <% end %>
                 data-behavior="populate-input, replace-trigger-label"
                 data-replace-with="<%= t('views.agents.form.visibility.is_public') %>"
                 data-replace-selector=".btn__label"
                 data-input-selector="input[name='agent[visibility]']"
                 data-input-value="is_public">
                <%= t('views.agents.form.visibility.is_public') %>
              </a>
            </li>
          </ul>
        </div>
      </div>
      <%= display_errors(agent, :visibility) %>
    </div>
  </div>

  <div class="field">
    <div class="control">
      <%= f.label :description %>
      <br />
      <%= f.text_area :description, id: :agent_description %>
      <%= display_errors(agent, :description) %>
    </div>
  </div>

  <div class="field">
    <div class="control">

      <div class="agent-background-header">
        <label><%= t('views.agents.form.background_label') %></label>
        <div class="btn-group" <% unless agent.image.nil? %>style="display:none;"<% end %>>
          <a href="#" class="btn btn--small <% if agent.image.nil? %>btn--primary <% end %>"
             data-action="agent-select-color">
            <%= t('views.agents.form.background_color_chooser') %>
          </a>
          <a href="#" class="btn btn--small <% unless agent.image.nil? %>btn--primary <% end %>"
             data-action="agent-select-image">
            <%= t('views.agents.form.background_image_chooser') %>
          </a>
        </div>
      </div>

      <div class="color-picker-preview background-color-gradient__<%= agent.color %>"
           <% unless agent.image.nil? %>style="display:none;"<% end %>>
        <% colors_array = agent.available_colors.map { |color| [color, color] } %>
        <div>
          <ul class="color-picker" data-input-selector="#agent-color-input">
            <% agent.available_colors.each do |color| %>
              <li>
                <a href="#"
                   class="background-color__<%= color %> <% if agent.color == color %>current<% end %>"
                   data-input-value="<%= color %>"></a>
              </li>
            <% end %>
          </ul>
        </div>
        <%= f.hidden_field :color, id: 'agent-color-input' %>
      </div>

      <div class="agent-image-options__image" <% if agent.image.nil? %>style="display:none;"<% end %>>
        <% unless agent.image.nil? %>
          <div class="agent-upload__destroy" style="background-image: url(<%= agent.image_url(:background) %>)">
            <a href="#" class="btn btn--small btn--destructive" data-action="agent-remove-image">
              <span class="icon icon--x-small"><%= icon_delete %></span>
              <%= t('views.agents.form.remove_image_background_btn') %>
            </a>
            <%= f.hidden_field :remove_image, id: 'agent-remove-image-input' %>
          </div>
        <% end %>

        <div class="agent-upload__new" <% unless agent.image.nil? %>style="display:none;"<% end %>>
          <div>
            <%= f.hidden_field :image, value: agent.cached_image_data %>
            <%= f.file_field :image, id: 'agent_image' %>
            <div class="help">
              <span class="icon icon--x-small"><%= icon_information %></span>
              <%= t('views.agents.form.upload_info') %>
            </div>
            <%= display_errors(agent, :image) %>
          </div>
        </div>
      </div>

    </div>
  </div>


  <%= hidden_field_tag :origin, @origin %>
  <div class="actions">
    <% if ["edit", "update"].include? action_name %>
      <% btn_label = t('views.agents.edit.btn') %>
    <% else %>
      <% btn_label = t('views.agents.new.btn') %>
    <% end %>
    <%= f.button btn_label, class: "btn btn--primary",
      data: {
        disable_with: "<span class='icon icon--spin'>#{icon_loading}</span> #{t('loading')}".html_safe
      }
    %>
    <a href="#" class="btn btn--plain" data-action='close-modal'><%= t('cancel') %></a>
  </div>
<% end %>
